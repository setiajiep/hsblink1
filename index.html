<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSBlinK Executive Dashboard</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- REACT LIBRARIES -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f8fafc; }
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-card-dark { background: #0f172a; border: 1px solid #1e293b; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .animate-enter { animation: enter 0.6s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes enter { to { opacity: 1; transform: translateY(0); } }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- KONFIGURASI API ---
        // PENTING: Ganti URL ini dengan URL Web App dari Deploy Script Google Apps Script yang baru
        const API_URL = "https://script.google.com/macros/s/AKfycbxXoPXd2Jfgh0iap9JliNnYaLLxYs3agFItsxaZ6T5vqPZEu0UyfqzPxTd0WUeyeNkB8Q/exec";

        // --- UTILS ---
        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
        
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            let str = val.toString().trim();
            const isNegativeWrapper = str.startsWith('(') && str.endsWith(')');
            // Handle format Indonesia (1.000,00) -> Hapus titik, ganti koma jadi titik
            let cleanStr = str.replace(/[^\d.,\-()]/g, '').replace(/\./g, '').replace(/,/g, '.').replace(/[()]/g, '');
            let num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : (isNegativeWrapper ? -Math.abs(num) : num);
        };

        // --- COMPONENTS ---

        const ChartComponent = ({ type, data, options = {}, height = 300 }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    const chartOptions = {
                        ...options,
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { family: "'Plus Jakarta Sans', sans-serif" } } },
                            tooltip: { 
                                backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                                padding: 12, 
                                cornerRadius: 8,
                                titleFont: { family: "'Plus Jakarta Sans', sans-serif", size: 13 },
                                bodyFont: { family: "'Plus Jakarta Sans', sans-serif", size: 12 },
                                displayColors: true,
                                boxPadding: 4
                            },
                            ...(options.plugins || {})
                        },
                        scales: options.scales || {}
                    };

                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: chartOptions
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, options]);

            return <div style={{ height: height, width: '100%' }}><canvas ref={canvasRef}></canvas></div>;
        };

        const StatCard = ({ title, value, subValue, trend, icon, colorClass, delay }) => (
            <div className={`glass-card p-6 rounded-xl animate-enter hover:shadow-lg transition-shadow duration-300`} style={{ animationDelay: `${delay}ms` }}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800 tracking-tight">{value}</h3>
                    </div>
                    <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10 text-opacity-100`}>
                        <i data-lucide={icon} className="w-5 h-5"></i>
                    </div>
                </div>
                <div className="mt-4 flex items-center text-sm">
                    {trend === 'up' ? <span className="text-emerald-500 flex items-center gap-1 font-medium"><i data-lucide="trending-up" className="w-3 h-3"></i> Naik</span> : 
                     trend === 'down' ? <span className="text-rose-500 flex items-center gap-1 font-medium"><i data-lucide="trending-down" className="w-3 h-3"></i> Turun</span> : 
                     <span className="text-slate-400">Stabil</span>}
                    <span className="text-slate-400 ml-2 text-xs">{subValue}</span>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [balanceStatus, setBalanceStatus] = useState('checking');

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    setLoading(true);
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    if (json.status === 'success') {
                        processData(json.data);
                    } else {
                        console.error("API Error:", json);
                    }
                } catch (err) {
                    console.error("Error fetching data", err);
                    // Mock Data on Error untuk mencegah blank screen
                    processData({ laba_rugi: [], neraca: { aset: [], pasiva: [] } });
                } finally {
                    setLoading(false);
                }
            };

            const processData = (apiData) => {
                const { laba_rugi, neraca } = apiData;

                // --- 1. PROSES DATA BULANAN DARI SCRIPT BARU ---
                // Mapping keys dari object 'bulanan' di script GAS
                const monthKeys = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

                // Inisialisasi array akumulator
                let monthlyAgg = monthKeys.map((key, index) => ({
                    month: monthLabels[index],
                    key: key,
                    revenue: 0,
                    expense: 0,
                    profit: 0
                }));

                const plItems = laba_rugi || [];
                const revenueItems = plItems.filter(i => i.kode_akun?.toString().startsWith('4'));
                const expenseItems = plItems.filter(i => ['5','6','9'].some(p => i.kode_akun?.toString().startsWith(p)));
                
                // Loop semua baris untuk mengisi data bulanan
                plItems.forEach(item => {
                    const isRev = item.kode_akun?.toString().startsWith('4');
                    const isExp = ['5','6','9'].some(p => item.kode_akun?.toString().startsWith(p));
                    
                    if ((isRev || isExp) && item.bulanan) {
                        monthKeys.forEach((key, idx) => {
                            // Ambil data bulanan, bersihkan format angka
                            const val = cleanNumber(item.bulanan[key]);
                            if (isRev) monthlyAgg[idx].revenue += val;
                            if (isExp) monthlyAgg[idx].expense += val;
                        });
                    }
                });

                // Hitung profit per bulan
                monthlyAgg.forEach(m => {
                    m.profit = m.revenue - m.expense;
                });

                // --- 2. HITUNG TOTAL TAHUNAN ---
                const totalRevenue = monthlyAgg.reduce((sum, m) => sum + m.revenue, 0);
                const totalExpense = monthlyAgg.reduce((sum, m) => sum + m.expense, 0);
                const calculatedNetProfit = totalRevenue - totalExpense;

                // --- 3. PROSES NERACA ---
                const rawAssets = neraca.aset || [];
                const validAssets = rawAssets.filter(i => i.kode && /^\d+$/.test(i.kode) && !i.nama.toLowerCase().includes('total'));
                const totalAsset = validAssets.reduce((sum, item) => sum + cleanNumber(item.saldo), 0);

                const rawPasiva = neraca.pasiva || [];
                let validPasiva = rawPasiva.filter(i => i.kode && /^\d+$/.test(i.kode) && !i.nama.toLowerCase().includes('total'));

                // Auto-Sync Laba Tahun Berjalan
                const labaIndex = validPasiva.findIndex(p => 
                    p.nama.toLowerCase().includes('laba tahun berjalan') || 
                    p.nama.toLowerCase().includes('current year') ||
                    p.nama.toLowerCase().includes('profit')
                );

                if (labaIndex !== -1) {
                    validPasiva[labaIndex] = {
                        ...validPasiva[labaIndex],
                        saldo: calculatedNetProfit, // Pakai hasil hitungan real
                        isAutoCalculated: true
                    };
                } else {
                    validPasiva.push({
                        kode: '39999',
                        nama: 'Laba Tahun Berjalan (System)',
                        saldo: calculatedNetProfit,
                        isAutoCalculated: true
                    });
                }

                const totalPasiva = validPasiva.reduce((sum, item) => sum + cleanNumber(item.saldo), 0);

                // Check Balance
                const diff = Math.abs(totalAsset - totalPasiva);
                const isBalanced = diff < 1000;
                setBalanceStatus(isBalanced ? 'balanced' : 'unbalanced');

                // Top Expenses (Pakai total tahunan dari object bulanan atau total_tahunan di row)
                const topExpenses = expenseItems
                    .map(i => ({ 
                        label: i.nama_akun, 
                        val: cleanNumber(i.total_tahunan) // Script GAS mengirim total_tahunan juga
                    }))
                    .filter(i => i.val > 0)
                    .sort((a,b) => b.val - a.val)
                    .slice(0, 5);

                setData({
                    totalAsset,
                    totalPasiva,
                    totalRevenue,
                    totalExpense,
                    netProfit: calculatedNetProfit,
                    assets: validAssets,
                    liabilities: validPasiva,
                    topExpenses,
                    plRows: [...revenueItems, ...expenseItems],
                    monthlyStats: monthlyAgg, // Data bulanan REAL
                    lastUpdated: new Date(apiData.generated_at || new Date())
                });
            };

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-500">
                    <div className="loader mb-4"></div>
                    <p className="font-medium animate-pulse text-sm">Menghubungkan ke Database...</p>
                </div>
            );

            // --- VIEW: DASHBOARD OVERVIEW ---
            const Overview = () => (
                <div className="space-y-6 animate-enter">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Total Aset" value={formatRupiah(data.totalAsset)} subValue="Posisi Neraca" trend="up" icon="wallet" colorClass="bg-blue-500 text-blue-600" delay="100"/>
                        <StatCard title="Pendapatan (YTD)" value={formatRupiah(data.totalRevenue)} subValue="Total Revenue" trend="up" icon="trending-up" colorClass="bg-emerald-500 text-emerald-600" delay="200"/>
                        <StatCard title="Beban Operasional" value={formatRupiah(data.totalExpense)} subValue="Total OpEx + HPP" trend="down" icon="trending-down" colorClass="bg-rose-500 text-rose-600" delay="300"/>
                        <StatCard title="Laba Bersih" value={formatRupiah(data.netProfit)} subValue="Net Profit" trend={data.netProfit >= 0 ? 'up' : 'down'} icon="pie-chart" colorClass={data.netProfit >= 0 ? "bg-indigo-500 text-indigo-600" : "bg-rose-500 text-rose-600"} delay="400"/>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="glass-card p-6 rounded-xl lg:col-span-2">
                            <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">
                                <i data-lucide="bar-chart-2" className="w-4 h-4 text-blue-500"></i> Komposisi Aset Utama
                            </h3>
                            <ChartComponent 
                                type="bar"
                                data={{
                                    labels: data.assets.filter(a => cleanNumber(a.saldo) > 0).map(a => a.nama),
                                    datasets: [{
                                        label: 'Saldo (IDR)',
                                        data: data.assets.filter(a => cleanNumber(a.saldo) > 0).map(a => cleanNumber(a.saldo)),
                                        backgroundColor: '#3b82f6',
                                        borderRadius: 4,
                                        barThickness: 40
                                    }]
                                }}
                            />
                        </div>

                        <div className="glass-card p-6 rounded-xl">
                            <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">
                                <i data-lucide="pie-chart" className="w-4 h-4 text-rose-500"></i> Top 5 Beban
                            </h3>
                            <ChartComponent 
                                type="doughnut"
                                height={250}
                                data={{
                                    labels: data.topExpenses.map(e => e.label),
                                    datasets: [{
                                        data: data.topExpenses.map(e => e.val),
                                        backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#06b6d4'],
                                        borderWidth: 0,
                                        hoverOffset: 10
                                    }]
                                }}
                            />
                            <div className="mt-8 text-center border-t border-slate-100 pt-4">
                                <p className="text-xs text-slate-400 font-medium uppercase">Total Beban</p>
                                <p className="font-bold text-slate-800 text-lg">{formatRupiah(data.totalExpense)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- VIEW: MONTHLY REPORT ---
            const MonthlyReport = () => (
                <div className="space-y-8 animate-enter">
                    {/* Header Summary */}
                    <div className="glass-card-dark p-6 rounded-xl text-white flex flex-col md:flex-row justify-between items-center gap-6">
                        <div className="text-center md:text-left">
                            <h3 className="text-slate-400 text-sm font-medium mb-1">Rata-rata Pendapatan Bulanan</h3>
                            <p className="text-2xl font-bold">{formatRupiah(data.totalRevenue / 12)} / bulan</p>
                        </div>
                        <div className="flex gap-4">
                             <div className="text-center bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p className="text-xs text-emerald-400 font-bold uppercase mb-1">Highest Income</p>
                                <p className="font-mono text-sm">{formatRupiah(Math.max(...data.monthlyStats.map(m => m.revenue)))}</p>
                            </div>
                            <div className="text-center bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p className="text-xs text-rose-400 font-bold uppercase mb-1">Highest Expense</p>
                                <p className="font-mono text-sm">{formatRupiah(Math.max(...data.monthlyStats.map(m => m.expense)))}</p>
                            </div>
                        </div>
                    </div>

                    {/* Chart: Income vs Expense */}
                    <div className="glass-card p-6 rounded-xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2 text-sm uppercase tracking-wide">
                                <i data-lucide="bar-chart" className="w-4 h-4 text-indigo-500"></i> Realisasi Arus Kas Bulanan
                            </h3>
                            <div className="flex gap-2 text-xs font-medium">
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> Pendapatan</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-rose-500"></span> Beban</span>
                            </div>
                        </div>
                        <ChartComponent 
                            type="bar"
                            height={320}
                            data={{
                                labels: data.monthlyStats.map(m => m.month),
                                datasets: [
                                    {
                                        label: 'Pendapatan',
                                        data: data.monthlyStats.map(m => m.revenue),
                                        backgroundColor: '#10b981',
                                        borderRadius: 4,
                                        barPercentage: 0.6,
                                        categoryPercentage: 0.8
                                    },
                                    {
                                        label: 'Beban',
                                        data: data.monthlyStats.map(m => m.expense),
                                        backgroundColor: '#ef4444',
                                        borderRadius: 4,
                                        barPercentage: 0.6,
                                        categoryPercentage: 0.8
                                    }
                                ]
                            }}
                            options={{
                                scales: {
                                    y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { callback: (val) => val / 1000000 + 'jt' } },
                                    x: { grid: { display: false } }
                                }
                            }}
                        />
                    </div>

                    {/* Chart: Profit Trend */}
                    <div className="glass-card p-6 rounded-xl">
                        <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <i data-lucide="activity" className="w-4 h-4 text-blue-500"></i> Tren Keuntungan Bersih (Net Profit)
                        </h3>
                        <ChartComponent 
                            type="line"
                            height={280}
                            data={{
                                labels: data.monthlyStats.map(m => m.month),
                                datasets: [
                                    {
                                        label: 'Keuntungan',
                                        data: data.monthlyStats.map(m => m.profit),
                                        borderColor: '#3b82f6',
                                        backgroundColor: (context) => {
                                            const ctx = context.chart.ctx;
                                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                                            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                            return gradient;
                                        },
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 4,
                                        pointHoverRadius: 6
                                    }
                                ]
                            }}
                            options={{
                                scales: {
                                    y: { grid: { color: '#f1f5f9' } },
                                    x: { grid: { display: false } }
                                }
                            }}
                        />
                    </div>

                    {/* Simple Table */}
                    <div className="glass-card rounded-xl overflow-hidden">
                         <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-sm text-slate-700 uppercase tracking-wide">
                            Rincian Angka Bulanan (Realtime)
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-white text-slate-500 font-semibold border-b border-slate-100 text-xs uppercase">
                                    <tr>
                                        <th className="px-6 py-3">Bulan</th>
                                        <th className="px-6 py-3 text-right text-emerald-600">Pemasukan</th>
                                        <th className="px-6 py-3 text-right text-rose-600">Pengeluaran</th>
                                        <th className="px-6 py-3 text-right text-blue-600">Profit</th>
                                        <th className="px-6 py-3 text-center">Margin</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.monthlyStats.map((row, i) => (
                                        <tr key={i} className="hover:bg-slate-50">
                                            <td className="px-6 py-3 font-medium text-slate-700">{row.month}</td>
                                            <td className="px-6 py-3 text-right font-mono">{formatRupiah(row.revenue)}</td>
                                            <td className="px-6 py-3 text-right font-mono">{formatRupiah(row.expense)}</td>
                                            <td className={`px-6 py-3 text-right font-mono font-bold ${row.profit >= 0 ? 'text-slate-700' : 'text-rose-600'}`}>
                                                {formatRupiah(row.profit)}
                                            </td>
                                            <td className="px-6 py-3 text-center text-xs text-slate-500">
                                                {row.revenue > 0 ? ((row.profit / row.revenue) * 100).toFixed(1) + '%' : '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            // --- VIEW: DETAIL TABLE ---
            const DetailTable = ({ title, items, isBalanceSheet = false }) => (
                <div className="glass-card rounded-xl overflow-hidden animate-enter shadow-sm">
                    <div className="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white gap-4">
                        <div>
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                {title}
                                {isBalanceSheet && balanceStatus === 'balanced' && (
                                    <span className="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wide border border-emerald-200">Balanced</span>
                                )}
                                {isBalanceSheet && balanceStatus === 'unbalanced' && (
                                    <span className="bg-rose-100 text-rose-700 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wide border border-rose-200">Unbalanced</span>
                                )}
                            </h2>
                        </div>
                        <button className="px-4 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 transition-colors uppercase tracking-wide flex items-center gap-2">
                            <i data-lucide="download" className="w-3 h-3"></i> Export PDF
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase tracking-wider text-xs">
                                <tr>
                                    <th className="px-6 py-4 w-32">Kode</th>
                                    <th className="px-6 py-4">Nama Akun</th>
                                    <th className="px-6 py-4 text-right">Saldo</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {items.map((item, idx) => {
                                    const val = isBalanceSheet ? cleanNumber(item.saldo) : cleanNumber(item.total_tahunan);
                                    if (val === 0) return null;
                                    const isNegative = val < 0;
                                    const isAuto = item.isAutoCalculated;
                                    return (
                                        <tr key={idx} className={`hover:bg-slate-50 transition-colors ${isAuto ? 'bg-blue-50/50' : ''}`}>
                                            <td className="px-6 py-4 font-mono text-slate-500 text-xs">{item.kode || item.kode_akun}</td>
                                            <td className="px-6 py-4 font-medium text-slate-700 flex items-center gap-2">
                                                {item.nama || item.nama_akun}
                                                {isAuto && <span className="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded border border-blue-200" title="Dihitung otomatis dari Laba Rugi">AUTO</span>}
                                            </td>
                                            <td className={`px-6 py-4 text-right font-mono font-medium ${isNegative ? 'text-rose-600' : 'text-slate-700'}`}>
                                                {isNegative ? `(${formatRupiah(Math.abs(val))})` : formatRupiah(val)}
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                             <tfoot className="bg-slate-50 font-bold text-slate-800 border-t border-slate-200">
                                <tr>
                                    <td colSpan="2" className="px-6 py-4 text-right uppercase text-xs tracking-wider text-slate-500">Total</td>
                                    <td className="px-6 py-4 text-right text-base">
                                        {formatRupiah(items.reduce((acc, curr) => acc + (isBalanceSheet ? cleanNumber(curr.saldo) : cleanNumber(curr.total_tahunan)), 0))}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );

            // --- MAIN RENDER ---
            return (
                <div className="flex min-h-screen font-sans text-slate-900">
                    {/* SIDEBAR */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 md:static md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="h-20 flex items-center px-6 border-b border-slate-800">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 text-white">
                                    <span className="font-bold text-xl">D</span>
                                </div>
                                <div>
                                    <h1 className="font-bold text-base leading-tight">HSBlinK</h1>
                                    <span className="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">Financial System</span>
                                </div>
                            </div>
                        </div>

                        <nav className="p-4 space-y-2 mt-4">
                            {[
                                { id: 'overview', label: 'Dashboard', icon: 'layout-dashboard' },
                                { id: 'monthly', label: 'Laporan Bulanan', icon: 'bar-chart' },
                                { id: 'pl', label: 'Laba Rugi', icon: 'trending-up' },
                                { id: 'neraca', label: 'Neraca', icon: 'file-text' }
                            ].map(menu => (
                                <button 
                                    key={menu.id}
                                    onClick={() => { setActiveTab(menu.id); if(window.innerWidth < 768) setSidebarOpen(false); }}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${activeTab === menu.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                                >
                                    <i data-lucide={menu.icon} className={`w-5 h-5 ${activeTab === menu.id ? 'text-white' : 'text-slate-500 group-hover:text-white'}`}></i>
                                    <span className="font-medium text-sm">{menu.label}</span>
                                </button>
                            ))}
                        </nav>
                        
                        <div className="absolute bottom-0 w-full p-6 border-t border-slate-800 bg-slate-900">
                             <div className="flex items-center gap-3">
                                <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_10px_#10b981]"></div>
                                <div className="text-xs text-slate-400">
                                    <p className="font-medium text-slate-300">System Online</p>
                                    <p>{data?.lastUpdated?.toLocaleTimeString('id-ID')}</p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* MAIN CONTENT WRAPPER */}
                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                         {/* Header Mobile */}
                         <div className="md:hidden h-16 bg-white border-b border-slate-200 flex items-center px-4 justify-between z-40 sticky top-0">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setSidebarOpen(true)} className="text-slate-600 p-1 rounded hover:bg-slate-100"><i data-lucide="menu"></i></button>
                                <span className="font-bold text-slate-800">HSBlinK</span>
                            </div>
                        </div>

                        {/* Content Scrollable */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                            <header className="flex justify-between items-end mb-8 animate-enter">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800 tracking-tight">
                                        {activeTab === 'overview' ? 'Executive Overview' : 
                                         activeTab === 'monthly' ? 'Laporan Bulanan' :
                                         activeTab === 'pl' ? 'Laporan Laba Rugi' : 'Posisi Keuangan (Neraca)'}
                                    </h2>
                                    <p className="text-slate-500 text-sm mt-1 font-medium">Periode Tahun Buku 2025</p>
                                </div>
                                <div className="hidden md:flex gap-4">
                                     <div className="bg-white px-4 py-2 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 flex items-center gap-2 shadow-sm uppercase tracking-wide">
                                        <i data-lucide="calendar" className="w-3 h-3 text-slate-400"></i>
                                        {new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}
                                    </div>
                                </div>
                            </header>

                            {/* DYNAMIC CONTENT */}
                            {activeTab === 'overview' && <Overview />}
                            {activeTab === 'monthly' && <MonthlyReport />}
                            
                            {activeTab === 'pl' && (
                                <div className="space-y-8 animate-enter">
                                    <DetailTable title="Pendapatan & Beban" items={data.plRows} />
                                    <div className="glass-card p-6 rounded-xl bg-slate-900 text-white flex justify-between items-center shadow-xl">
                                        <span className="font-bold text-lg tracking-wide">LABA BERSIH (NET PROFIT)</span>
                                        <span className={`font-mono text-2xl font-bold ${data.netProfit < 0 ? 'text-rose-400' : 'text-emerald-400'}`}>
                                            {formatRupiah(data.netProfit)}
                                        </span>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'neraca' && (
                                <div className="space-y-6 animate-enter">
                                    {/* Balance Indicator Header */}
                                    <div className={`p-4 rounded-xl border flex items-center justify-between ${balanceStatus === 'balanced' ? 'bg-emerald-50 border-emerald-200' : 'bg-rose-50 border-rose-200'}`}>
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-full ${balanceStatus === 'balanced' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                                                <i data-lucide={balanceStatus === 'balanced' ? 'check' : 'alert-triangle'} className="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <h4 className={`font-bold ${balanceStatus === 'balanced' ? 'text-emerald-800' : 'text-rose-800'}`}>
                                                    {balanceStatus === 'balanced' ? 'Neraca Seimbang (Balanced)' : 'Neraca Tidak Seimbang'}
                                                </h4>
                                                <p className="text-xs text-slate-500 mt-0.5">
                                                    Total Aset: {formatRupiah(data.totalAsset)} | Total Pasiva: {formatRupiah(data.totalPasiva)}
                                                </p>
                                            </div>
                                        </div>
                                        {balanceStatus === 'unbalanced' && (
                                            <span className="font-mono font-bold text-rose-600">Selisih: {formatRupiah(data.totalAsset - data.totalPasiva)}</span>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        <DetailTable title="Aset (Aktiva)" items={data.assets} isBalanceSheet={true} />
                                        <DetailTable title="Kewajiban & Ekuitas (Pasiva)" items={data.liabilities} isBalanceSheet={true} />
                                    </div>
                                </div>
                            )}

                            <footer className="mt-12 text-center text-xs text-slate-400 pb-8 font-medium">
                                &copy; 2025 HSBlinK Financial System.
                            </footer>
                        </div>
                    </main>

                    {/* Overlay for Mobile Sidebar */}
                    {sidebarOpen && <div onClick={() => setSidebarOpen(false)} className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm"></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
