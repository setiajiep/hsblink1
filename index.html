<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSBlinK Executive Dashboard</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- REACT LIBRARIES -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f8fafc; }
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-card-dark { background: #0f172a; border: 1px solid #1e293b; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .animate-enter { animation: enter 0.6s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes enter { to { opacity: 1; transform: translateY(0); } }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbxXoPXd2Jfgh0iap9JliNnYaLLxYs3agFItsxaZ6T5vqPZEu0UyfqzPxTd0WUeyeNkB8Q/exec";

        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
        
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            let str = val.toString().trim();
            const isNegativeWrapper = str.startsWith('(') && str.endsWith(')');
            let cleanStr = str.replace(/[^\d.,\-()]/g, '').replace(/\./g, '').replace(/,/g, '.').replace(/[()]/g, '');
            let num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : (isNegativeWrapper ? -Math.abs(num) : num);
        };

        const ChartComponent = ({ type, data, options = {}, height = 300 }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    const chartOptions = {
                        ...options,
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { family: "'Plus Jakarta Sans', sans-serif" } } },
                            tooltip: { 
                                backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                                padding: 12, 
                                cornerRadius: 8,
                                displayColors: true,
                            },
                            ...(options.plugins || {})
                        },
                        scales: options.scales || {}
                    };

                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: chartOptions
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, options]);

            return <div style={{ height: height, width: '100%' }}><canvas ref={canvasRef}></canvas></div>;
        };

        const StatCard = ({ title, value, subValue, trend, icon, colorClass, delay }) => (
            <div className={`glass-card p-6 rounded-xl animate-enter hover:shadow-lg transition-shadow duration-300`} style={{ animationDelay: `${delay}ms` }}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800 tracking-tight">{value}</h3>
                    </div>
                    <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10 text-opacity-100`}>
                        <i data-lucide={icon} className="w-5 h-5"></i>
                    </div>
                </div>
                <div className="mt-4 flex items-center text-sm">
                    {trend === 'up' ? <span className="text-emerald-500 flex items-center gap-1 font-medium"><i data-lucide="trending-up" className="w-3 h-3"></i> Naik</span> : 
                     trend === 'down' ? <span className="text-rose-500 flex items-center gap-1 font-medium"><i data-lucide="trending-down" className="w-3 h-3"></i> Turun</span> : 
                     <span className="text-slate-400">Stabil</span>}
                    <span className="text-slate-400 ml-2 text-xs">{subValue}</span>
                </div>
            </div>
        );

        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [balanceStatus, setBalanceStatus] = useState('checking');

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    setLoading(true);
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    if (json.status === 'success') {
                        processData(json.data);
                    }
                } catch (err) {
                    processData({ laba_rugi: [], neraca: { aset: [], pasiva: [] } });
                } finally {
                    setLoading(false);
                }
            };

            const processData = (apiData) => {
                const { laba_rugi, neraca } = apiData;

                const monthKeys = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

                let monthlyAgg = monthKeys.map((key, index) => ({
                    month: monthLabels[index],
                    revenue: 0,
                    expense: 0,
                    profit: 0
                }));

                const plItems = laba_rugi || [];
                // Pisahkan Pendapatan (Kode 4) dan Beban (5, 6, 9)
                const revenueItems = plItems.filter(i => i.kode_akun?.toString().startsWith('4'));
                const expenseItems = plItems.filter(i => ['5','6','9'].some(p => i.kode_akun?.toString().startsWith(p)));
                
                plItems.forEach(item => {
                    const isRev = item.kode_akun?.toString().startsWith('4');
                    const isExp = ['5','6','9'].some(p => item.kode_akun?.toString().startsWith(p));
                    
                    if ((isRev || isExp) && item.bulanan) {
                        monthKeys.forEach((key, idx) => {
                            const val = cleanNumber(item.bulanan[key]);
                            if (isRev) monthlyAgg[idx].revenue += val;
                            if (isExp) monthlyAgg[idx].expense += val;
                        });
                    }
                });

                monthlyAgg.forEach(m => { m.profit = m.revenue - m.expense; });

                const totalRevenue = monthlyAgg.reduce((sum, m) => sum + m.revenue, 0);
                const totalExpense = monthlyAgg.reduce((sum, m) => sum + m.expense, 0);
                const calculatedNetProfit = totalRevenue - totalExpense;

                const rawAssets = neraca.aset || [];
                const validAssets = rawAssets.filter(i => i.kode && /^\d+$/.test(i.kode) && !i.nama.toLowerCase().includes('total'));
                const totalAsset = validAssets.reduce((sum, item) => sum + cleanNumber(item.saldo), 0);

                const rawPasiva = neraca.pasiva || [];
                let validPasiva = rawPasiva.filter(i => i.kode && /^\d+$/.test(i.kode) && !i.nama.toLowerCase().includes('total'));

                const labaIndex = validPasiva.findIndex(p => p.nama.toLowerCase().includes('laba tahun berjalan') || p.nama.toLowerCase().includes('profit'));
                if (labaIndex !== -1) {
                    validPasiva[labaIndex] = { ...validPasiva[labaIndex], saldo: calculatedNetProfit, isAutoCalculated: true };
                } else {
                    validPasiva.push({ kode: '39999', nama: 'Laba Tahun Berjalan (System)', saldo: calculatedNetProfit, isAutoCalculated: true });
                }

                const totalPasiva = validPasiva.reduce((sum, item) => sum + cleanNumber(item.saldo), 0);
                const isBalanced = Math.abs(totalAsset - totalPasiva) < 1000;
                setBalanceStatus(isBalanced ? 'balanced' : 'unbalanced');

                const topExpenses = expenseItems
                    .map(i => ({ label: i.nama_akun, val: cleanNumber(i.total_tahunan) }))
                    .filter(i => i.val > 0)
                    .sort((a,b) => b.val - a.val)
                    .slice(0, 5);

                setData({
                    totalAsset,
                    totalPasiva,
                    totalRevenue,
                    totalExpense,
                    netProfit: calculatedNetProfit,
                    assets: validAssets,
                    liabilities: validPasiva,
                    topExpenses,
                    revenueItems,
                    expenseItems,
                    monthlyStats: monthlyAgg,
                    lastUpdated: new Date()
                });
            };

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-500">
                    <div className="loader mb-4"></div>
                    <p className="font-medium animate-pulse text-sm">Menghubungkan ke Database...</p>
                </div>
            );

            const DetailTable = ({ title, items, isBalanceSheet = false, colorScheme = 'slate' }) => {
                const total = items.reduce((acc, curr) => acc + (isBalanceSheet ? cleanNumber(curr.saldo) : cleanNumber(curr.total_tahunan)), 0);
                
                return (
                    <div className="glass-card rounded-xl overflow-hidden animate-enter shadow-sm">
                        <div className={`p-5 border-b border-slate-100 flex justify-between items-center bg-white`}>
                            <h2 className={`text-lg font-bold text-${colorScheme === 'emerald' ? 'emerald-700' : colorScheme === 'rose' ? 'rose-700' : 'slate-800'} flex items-center gap-2 uppercase tracking-wide`}>
                                {title}
                            </h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-bold uppercase tracking-wider text-[10px]">
                                    <tr>
                                        <th className="px-6 py-4 w-32">Kode</th>
                                        <th className="px-6 py-4">Nama Akun</th>
                                        <th className="px-6 py-4 text-right">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {items.map((item, idx) => {
                                        const val = isBalanceSheet ? cleanNumber(item.saldo) : cleanNumber(item.total_tahunan);
                                        if (val === 0) return null;
                                        return (
                                            <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 font-mono text-slate-500 text-xs">{item.kode || item.kode_akun}</td>
                                                <td className="px-6 py-4 font-medium text-slate-700">{item.nama || item.nama_akun}</td>
                                                <td className={`px-6 py-4 text-right font-mono font-medium ${val < 0 ? 'text-rose-600' : 'text-slate-700'}`}>
                                                    {val < 0 ? `(${formatRupiah(Math.abs(val))})` : formatRupiah(val)}
                                                </td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                                <tfoot className={`bg-${colorScheme}-50/50 font-bold text-slate-800 border-t border-slate-200`}>
                                    <tr>
                                        <td colSpan="2" className="px-6 py-4 text-right uppercase text-xs tracking-wider text-slate-500">Total {title}</td>
                                        <td className={`px-6 py-4 text-right text-base ${colorScheme === 'emerald' ? 'text-emerald-700' : colorScheme === 'rose' ? 'text-rose-700' : ''}`}>
                                            {formatRupiah(total)}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen font-sans text-slate-900">
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 md:static md:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="h-20 flex items-center px-6 border-b border-slate-800">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg text-white">
                                    <span className="font-bold text-xl">D</span>
                                </div>
                                <h1 className="font-bold text-base leading-tight">HSBlinK</h1>
                            </div>
                        </div>
                        <nav className="p-4 space-y-2 mt-4">
                            {[
                                { id: 'overview', label: 'Dashboard', icon: 'layout-dashboard' },
                                { id: 'monthly', label: 'Laporan Bulanan', icon: 'bar-chart' },
                                { id: 'pl', label: 'Laba Rugi', icon: 'trending-up' },
                                { id: 'neraca', label: 'Neraca', icon: 'file-text' }
                            ].map(menu => (
                                <button 
                                    key={menu.id}
                                    onClick={() => setActiveTab(menu.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === menu.id ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                                >
                                    <i data-lucide={menu.icon} className="w-5 h-5"></i>
                                    <span className="font-medium text-sm">{menu.label}</span>
                                </button>
                            ))}
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col h-screen overflow-hidden relative">
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            <header className="flex justify-between items-end mb-8 animate-enter">
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800 tracking-tight">
                                        {activeTab === 'overview' ? 'Executive Overview' : 
                                         activeTab === 'monthly' ? 'Laporan Bulanan' :
                                         activeTab === 'pl' ? 'Laporan Laba Rugi' : 'Posisi Keuangan (Neraca)'}
                                    </h2>
                                    <p className="text-slate-500 text-sm mt-1 font-medium">Periode Tahun Buku {new Date().getFullYear()}</p>
                                </div>
                            </header>

                            {/* DASHBOARD OVERVIEW */}
                            {activeTab === 'overview' && (
                                <div className="space-y-6 animate-enter">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <StatCard title="Total Aset" value={formatRupiah(data.totalAsset)} subValue="Posisi Neraca" trend="up" icon="wallet" colorClass="bg-blue-500 text-blue-600" delay="100"/>
                                        <StatCard title="Pendapatan (YTD)" value={formatRupiah(data.totalRevenue)} subValue="Total Revenue" trend="up" icon="trending-up" colorClass="bg-emerald-500 text-emerald-600" delay="200"/>
                                        <StatCard title="Beban Operasional" value={formatRupiah(data.totalExpense)} subValue="Total OpEx + HPP" trend="down" icon="trending-down" colorClass="bg-rose-500 text-rose-600" delay="300"/>
                                        <StatCard title="Laba Bersih" value={formatRupiah(data.netProfit)} subValue="Net Profit" trend={data.netProfit >= 0 ? 'up' : 'down'} icon="pie-chart" colorClass={data.netProfit >= 0 ? "bg-indigo-500 text-indigo-600" : "bg-rose-500 text-rose-600"} delay="400"/>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="glass-card p-6 rounded-xl lg:col-span-2">
                                            <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">Komposisi Aset</h3>
                                            <ChartComponent 
                                                type="bar"
                                                data={{
                                                    labels: data.assets.filter(a => cleanNumber(a.saldo) > 0).map(a => a.nama),
                                                    datasets: [{ label: 'Saldo', data: data.assets.filter(a => cleanNumber(a.saldo) > 0).map(a => cleanNumber(a.saldo)), backgroundColor: '#3b82f6', borderRadius: 4 }]
                                                }}
                                            />
                                        </div>
                                        <div className="glass-card p-6 rounded-xl">
                                            <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide">Top 5 Beban</h3>
                                            <ChartComponent 
                                                type="doughnut"
                                                height={250}
                                                data={{
                                                    labels: data.topExpenses.map(e => e.label),
                                                    datasets: [{ data: data.topExpenses.map(e => e.val), backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#06b6d4'], borderWidth: 0 }]
                                                }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* MONTHLY REPORT */}
                            {activeTab === 'monthly' && (
                                <div className="space-y-8 animate-enter">
                                    <div className="glass-card p-6 rounded-xl">
                                        <h3 className="font-bold text-slate-800 mb-6 uppercase text-sm tracking-wide">Realisasi Bulanan</h3>
                                        <ChartComponent 
                                            type="bar"
                                            data={{
                                                labels: data.monthlyStats.map(m => m.month),
                                                datasets: [
                                                    { label: 'Pendapatan', data: data.monthlyStats.map(m => m.revenue), backgroundColor: '#10b981', borderRadius: 4 },
                                                    { label: 'Beban', data: data.monthlyStats.map(m => m.expense), backgroundColor: '#ef4444', borderRadius: 4 }
                                                ]
                                            }}
                                        />
                                    </div>
                                    <div className="glass-card rounded-xl overflow-hidden">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-[10px]">
                                                <tr>
                                                    <th className="px-6 py-4">Bulan</th>
                                                    <th className="px-6 py-4 text-right">Pemasukan</th>
                                                    <th className="px-6 py-4 text-right">Pengeluaran</th>
                                                    <th className="px-6 py-4 text-right">Laba/Rugi</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {data.monthlyStats.map((row, i) => (
                                                    <tr key={i}>
                                                        <td className="px-6 py-4 font-medium">{row.month}</td>
                                                        <td className="px-6 py-4 text-right">{formatRupiah(row.revenue)}</td>
                                                        <td className="px-6 py-4 text-right">{formatRupiah(row.expense)}</td>
                                                        <td className={`px-6 py-4 text-right font-bold ${row.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{formatRupiah(row.profit)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            {/* NEW: PROFIT & LOSS STRUCTURE */}
                            {activeTab === 'pl' && (
                                <div className="space-y-8 animate-enter">
                                    {/* 1. SECTION PENDAPATAN */}
                                    <DetailTable title="Pendapatan" items={data.revenueItems} colorScheme="emerald" />

                                    {/* 2. SECTION BEBAN */}
                                    <DetailTable title="Beban" items={data.expenseItems} colorScheme="rose" />

                                    {/* 3. FINAL NET PROFIT */}
                                    <div className="glass-card p-8 rounded-2xl bg-slate-900 text-white flex flex-col md:flex-row justify-between items-center shadow-2xl border-t-4 border-blue-500">
                                        <div>
                                            <span className="text-slate-400 text-xs font-bold uppercase tracking-[0.2em]">Hasil Akhir</span>
                                            <h2 className="text-2xl font-bold tracking-tight mt-1">LABA BERSIH (NET PROFIT)</h2>
                                        </div>
                                        <div className="text-right mt-4 md:mt-0">
                                            <div className={`text-3xl md:text-4xl font-mono font-bold ${data.netProfit < 0 ? 'text-rose-400' : 'text-emerald-400'}`}>
                                                {data.netProfit < 0 ? `(${formatRupiah(Math.abs(data.netProfit))})` : formatRupiah(data.netProfit)}
                                            </div>
                                            <p className="text-xs text-slate-500 mt-2 font-medium italic">Akumulasi pendapatan dikurangi seluruh beban operasional & pajak</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'neraca' && (
                                <div className="space-y-6 animate-enter">
                                    <div className={`p-4 rounded-xl border flex items-center justify-between ${balanceStatus === 'balanced' ? 'bg-emerald-50 border-emerald-200 text-emerald-800' : 'bg-rose-50 border-rose-200 text-rose-800'}`}>
                                        <div className="flex items-center gap-3">
                                            <i data-lucide={balanceStatus === 'balanced' ? 'check' : 'alert-triangle'}></i>
                                            <span className="font-bold">{balanceStatus === 'balanced' ? 'Neraca Seimbang' : 'Neraca Tidak Seimbang'}</span>
                                        </div>
                                        <span className="font-mono">Selisih: {formatRupiah(data.totalAsset - data.totalPasiva)}</span>
                                    </div>
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        <DetailTable title="Aset (Aktiva)" items={data.assets} isBalanceSheet={true} />
                                        <DetailTable title="Pasiva (Kewajiban & Ekuitas)" items={data.liabilities} isBalanceSheet={true} />
                                    </div>
                                </div>
                            )}

                            <footer className="mt-12 text-center text-xs text-slate-400 pb-8">
                                &copy; {new Date().getFullYear()} HSBlinK Financial System.
                            </footer>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
